pipeline {
    agent any

    environment {
        NODE_HOME = tool name: 'Node18', type: 'jenkins.plugins.nodejs.tools.NodeJSInstallation'
        PATH = "${NODE_HOME}/bin:${env.PATH}"
    }

    stages {
        stage('Checkout') {
            steps {
                echo 'üì• Checking out repository...'
                checkout([$class: 'GitSCM',
                    branches: [[name: '*/main']],
                    userRemoteConfigs: [[
                        url: 'https://github.com/Sai-Khush/Walleto.git',
                        credentialsId: 'github-https-pat'
                    ]]
                ])
            }
        }

        stage('Clean Workspace') {
            steps {
                echo 'üßπ Cleaning old workspace...'
                dir('Code/walleto') {
                    sh 'rm -rf node_modules package-lock.json .next'
                }
            }
        }

        stage('Install Dependencies') {
            steps {
                echo 'üì¶ Installing ALL dependencies (including devDependencies)...'
                dir('Code/walleto') {
                    // Force a full clean install with devDependencies
                    sh 'npm ci --include=dev'
                }
            }
        }

        stage('Build') {
            steps {
                echo 'üèóÔ∏è Building Next.js project...'
                dir('Code/walleto') {
                    sh 'npm run build'
                }
            }
        }

        stage('Deploy to DEV') {
            when {
                expression { currentBuild.currentResult == 'SUCCESS' }
            }
            steps {
                echo 'üöÄ Deploying build to DEV environment...'
                dir('Code/walleto/out') {
                    sh '''
                        # Example deploy path (change if needed)
                        sudo rm -rf /var/www/html/walleto/*
                        sudo cp -r * /var/www/html/walleto/
                    '''
                }
            }
        }
    }

    post {
        success {
            echo '‚úÖ Deployment successful!'
        }
        failure {
            echo '‚ùå Deployment failed.'
        }
    }
}
