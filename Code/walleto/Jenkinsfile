pipeline {
    agent any

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Clean Workspace') {
            steps {
                echo "üßπ Cleaning old workspace..."
                dir('Code/walleto') {
                    sh 'rm -rf node_modules package-lock.json'
                }
            }
        }

        stage('Install Dependencies') {
            steps {
                echo "üì¶ Installing dependencies in Code/walleto..."
                dir('Code/walleto') {
                    sh '''
                        echo "Installing main dependencies..."
                        npm install --no-audit --no-fund --foreground-scripts=false --prefer-offline

                        echo "Manually ensuring TypeScript exists locally..."
                        npm install typescript@latest --save-dev

                        echo "Verifying TypeScript installation..."
                        npx tsc --version || true
                        ls -la node_modules/typescript/bin || true
                    '''
                }
            }
        }

        stage('Build') {
            steps {
                echo "üèóÔ∏è Building Next.js project..."
                dir('Code/walleto') {
                    sh '''
                        echo "Checking if TypeScript is visible before build..."
                        npx tsc --version || true
                        export NODE_PATH=$(npm root)
                        echo "NODE_PATH set to: $NODE_PATH"
                        npm run build || (echo "‚ùå Build failed! Checking TypeScript..." && ls -R node_modules/typescript || true)
                    '''
                }
            }
        }

        stage('Deploy to DEV') {
            when {
                expression { currentBuild.currentResult == 'SUCCESS' }
            }
            steps {
                echo "üöÄ Deployment stage (DEV) - build passed!"
            }
        }
    }

    post {
        success {
            echo "‚úÖ Deployment successful!"
        }
        failure {
            echo "‚ùå Deployment failed. Check logs above."
        }
    }
}
